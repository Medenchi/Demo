<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CRM-—Å–∏–º—É–ª—è—Ç–æ—Ä</title>
  <style>
    :root{
      /* –¶–≤–µ—Ç–∞ */
      --yx-bg:#15181d; --yx-surface:#1b1f26; --yx-card:#1f2430; --yx-text:#f1f4f8; --yx-muted:#9aa3b2;
      --yx-accent:#7fd45b; --yx-link:#89b8ff; --yx-chip:#262c37; --yx-divider:#2b3140;
      --tg-bg:#0e1116; --tg-header:#161a22; --tg-bot:#262c37; --tg-user:#3b2f26;
      --tg-muted:#a4aab6; --tg-btn:#2a3140; --tg-green:#45c46f; --tg-red:#ef5350;

      --radius:16px; --radius-lg:22px;
      --max-phone: 480px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#0c0f14; color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:clamp(8px, 2vw, 16px);
      gap:clamp(10px, 1.5vh, 16px);
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∞–¥–∞–ø—Ç–∏–≤ –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω—ã) */
    .app-root{
      width:min(100%, var(--max-phone));
      height:calc(100dvh - clamp(12px, 3vh, 28px)*2);
      min-height:540px;
      background:var(--yx-bg);
      border-radius:var(--radius-lg);
      overflow:hidden;
      box-shadow:0 18px 60px rgba(0,0,0,.6), inset 0 0 1px rgba(255,255,255,.06);
      display:flex; flex-direction:column;
    }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π */
    .switch{display:flex; gap:10px; width:min(100%, var(--max-phone))}
    .sw{flex:1; padding:12px 14px; border-radius:12px; border:1px solid #343a48; background:#222634; color:#fff; cursor:pointer; font-weight:600}
    .sw.active{background:var(--yx-link); color:#10151c; border-color:var(--yx-link)}

    /* –≠–∫—Ä–∞–Ω—ã */
    .screen{flex:1; display:none}
    .screen.visible{display:flex; flex-direction:column; min-height:0}

    /* ‚Äú–Ø–Ω–¥–µ–∫—Å‚Äù-—ç–∫—Ä–∞–Ω (–±–µ–∑ —Ñ–æ—Ç–æ-—à–∞–ø–∫–∏ –∏ –±–µ–∑ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è) */
    .yx-toolbar{
      background:linear-gradient(180deg, #131720, #10141a);
      border-bottom:1px solid var(--yx-divider);
      height:48px; display:flex; align-items:center; justify-content:center;
      padding:0 12px;
    }
    .toolbar-title{font-weight:700; font-size:clamp(14px, 3.8vw, 16px)}
    .yx-scroll{flex:1; overflow:auto; padding:12px}
    .yx-scroll::-webkit-scrollbar{width:6px} .yx-scroll::-webkit-scrollbar-thumb{background:#2a2e3a; border-radius:4px}

    .yx-title-card{
      background:var(--yx-card); border-radius:18px; padding:14px; box-shadow:0 8px 18px rgba(0,0,0,.35);
      display:flex; gap:12px; align-items:center; margin-bottom:10px;
    }
    .ava{width:48px; height:48px; border-radius:12px; background:#2a3140; display:flex; align-items:center; justify-content:center; font-weight:800}
    .yx-title h1{margin:0; font-size:clamp(18px, 5vw, 22px)}
    .rating{display:flex; gap:8px; align-items:center; color:#ffd54f; font-size:clamp(12px, 3.6vw, 14px)}
    .rating span{color:var(--yx-muted)}
    .action{display:flex; gap:10px; margin:12px 0}
    .yx-btn{flex:1; padding:14px; border:none; border-radius:14px; background:var(--yx-accent); color:#10151a; font-weight:800; cursor:pointer}

    .chips{display:flex; gap:8px; overflow:auto; padding-bottom:4px}
    .chip{background:var(--yx-chip); border:1px solid var(--yx-divider); color:#c9d0dc; padding:8px 12px; border-radius:999px; white-space:nowrap; user-select:none}

    .card{background:var(--yx-surface); border:1px solid var(--yx-divider); border-radius:16px; padding:12px; margin:10px 0}
    .card-title{font-weight:800; margin-bottom:6px}
    .muted{color:var(--yx-muted); font-size:clamp(12px, 3.5vw, 13px)}
    .busy{display:grid; grid-template-columns:repeat(12,1fr); gap:6px; align-items:end; height:60px}
    .busy div{background:#333a4a; border-radius:4px}

    .yx-footer{
      display:flex; justify-content:space-around; align-items:center; height:52px;
      background:#121722; border-top:1px solid var(--yx-divider);
    }
    .foot-btn{background:none; border:none; color:var(--yx-link); font-weight:600; cursor:pointer}

    /* –¢–µ–ª–µ–≥—Ä–∞–º-—ç–∫—Ä–∞–Ω */
    .tg-header{
      height:54px; background:var(--tg-header); border-bottom:1px solid #232a3a;
      display:flex; align-items:center; gap:10px; padding:0 12px;
    }
    .tg-ava{width:34px; height:34px; border-radius:50%; background:#2b3140; display:flex; align-items:center; justify-content:center; font-weight:800}
    .tg-title{display:flex; flex-direction:column}
    .tg-title b{font-size:clamp(13px, 3.8vw, 15px)}
    .tg-title span{font-size:clamp(11px, 3.3vw, 12px); color:var(--tg-muted)}

    .chat{flex:1; overflow:auto; padding:12px; background:var(--tg-bg)}
    .chat::-webkit-scrollbar{width:6px} .chat::-webkit-scrollbar-thumb{background:#2a2f3b; border-radius:4px}

    .msg{margin:8px 0; display:flex}
    .msg.bot{justify-content:flex-start}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:85%; padding:10px 12px; border-radius:18px; line-height:1.4; font-size:clamp(14px, 3.8vw, 15px); white-space:pre-wrap}
    .msg.bot .bubble{background:var(--tg-bot); border-bottom-left-radius:6px}
    .msg.user .bubble{background:var(--tg-user); border-bottom-right-radius:6px}

    .kb{border-top:1px solid #232a3a; padding:10px; background:var(--tg-bg)}
    .grid{display:grid; gap:8px}
    .grid.cols-3{grid-template-columns:repeat(3, 1fr)}
    .tbtn{background:var(--tg-btn); color:#fff; padding:12px; border:none; border-radius:12px; cursor:pointer}
    .tbtn.ok{background:var(--tg-green); color:#111}
    .tbtn.no{background:var(--tg-red)}

    .inline-actions{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}

    .inputbar{display:flex; gap:8px; padding:8px 10px; border-top:1px solid #232a3a; background:var(--tg-header)}
    .in{flex:1; background:#1b2130; border:1px solid #2a3140; border-radius:14px; color:#fff; padding:10px 12px; font-size:16px}
    .send{background:var(--yx-link); color:#111; border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer}

    @media (min-width: 700px){
      body{padding:24px 20px}
      .switch{gap:12px}
    }
  </style>
</head>
<body>
  <div class="app-root" id="app">
    <!-- –≠–∫—Ä–∞–Ω ‚Äú–Ø–Ω–¥–µ–∫—Å‚Äù -->
    <section id="screen-yx" class="screen visible">
      <div class="yx-toolbar">
        <div class="toolbar-title">–ö–∞—Ä—Ç–æ—á–∫–∞</div>
      </div>

      <div class="yx-scroll">
        <div class="yx-title-card">
          <div class="ava" id="yx-ava">ST</div>
          <div class="yx-title">
            <h1 id="yx-title">–°—Ç—É–¥–∏—è</h1>
            <div class="rating"><div>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><span>5,0 ‚Ä¢ 290 –æ—Ü–µ–Ω–æ–∫</span></div>
          </div>
        </div>

        <div class="action">
          <button class="yx-btn" id="open-tg">üïí –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω</button>
        </div>

        <div class="chips">
          <div class="chip">–û–±–∑–æ—Ä</div>
          <div class="chip">–¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏</div>
          <div class="chip">–§–æ—Ç–æ</div>
          <div class="chip">–û—Ç–∑—ã–≤—ã</div>
          <div class="chip">–û –Ω–∞—Å</div>
        </div>

        <div class="card">
          <div class="card-title">–ê–¥—Ä–µ—Å</div>
          <div class="muted">‚Äî –∞–¥—Ä–µ—Å —Å–∫—Ä—ã—Ç (–¥–µ–º–æ)</div>
        </div>

        <div class="card">
          <div class="card-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
          <div class="muted">–¢–µ–ª–µ—Ñ–æ–Ω: ‚Äî</div>
          <div class="muted">–°–∞–π—Ç: ‚Äî</div>
          <div class="muted">WhatsApp: ‚Äî</div>
        </div>

        <div class="card">
          <div class="card-title">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</div>
          <div class="muted">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 10:00‚Äì21:00 (–¥–µ–º–æ)</div>
          <div style="height:10px"></div>
          <div class="muted">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
          <div class="busy" id="busy"></div>
        </div>

        <div class="card">
          <div class="card-title">–û—Ç–∑—ã–≤—ã</div>
          <div class="muted">–û—Ç–∑—ã–≤—ã —Å–∫—Ä—ã—Ç—ã (–¥–µ–º–æ)</div>
        </div>

        <div class="card">
          <div class="card-title">–£—Å–ª—É–≥–∏</div>
          <div class="muted" id="svc">‚Äî</div>
        </div>
      </div>

      <div class="yx-footer">
        <button class="foot-btn" id="route">üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç</button>
        <button class="foot-btn" id="call">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
        <button class="foot-btn" id="share">‚Ü™Ô∏è –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    </section>

    <!-- –≠–∫—Ä–∞–Ω ‚ÄúTelegram‚Äù -->
    <section id="screen-tg" class="screen">
      <div class="tg-header">
        <div class="tg-ava" id="tg-ava">ST</div>
        <div class="tg-title">
          <b id="tg-title">–ó–∞–ø–∏—Å—å ‚Ä¢ –°—Ç—É–¥–∏—è</b>
          <span id="tg-sub">–±–æ—Ç –æ–Ω–ª–∞–π–Ω</span>
        </div>
      </div>

      <div class="chat" id="chat"></div>
      <div class="kb" id="kb"></div>
      <div class="inputbar">
        <input id="inp" class="in" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="send" class="send">–û—Ç–ø—Ä.</button>
      </div>
    </section>
  </div>

  <div class="switch">
    <button id="sw-client" class="sw active">–ö–ª–∏–µ–Ω—Ç</button>
    <button id="sw-admin" class="sw">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
  </div>

  <!-- –ß–∞—Å—Ç—å 2 ‚Äî JS –≤—Å—Ç–∞–≤—å –Ω–∏–∂–µ -->
  <script>
/* ===================== –ë–ê–ó–ê ===================== */
const VERSION='6.3-responsive'; // –Ω–µ –º–µ–Ω—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —á–∞—Ç—ã
const DEFAULT_DATA = {
  masters:["–ê–Ω–Ω–∞","–û–ª—å–≥–∞","–ú–∞—Ä–∏—è"],
  services:[
    {name:"–°—Ç—Ä–∏–∂–∫–∞ –∂–µ–Ω—Å–∫–∞—è (–∫–æ—Ä–æ—Ç–∫–∏–µ)", price:1500},
    {name:"–°—Ç—Ä–∏–∂–∫–∞ –∂–µ–Ω—Å–∫–∞—è (—Å—Ä–µ–¥–Ω–∏–µ)", price:2000},
    {name:"–°—Ç—Ä–∏–∂–∫–∞ –∂–µ–Ω—Å–∫–∞—è (–¥–ª–∏–Ω–Ω—ã–µ)", price:2500},
    {name:"–°—Ç—Ä–∏–∂–∫–∞ –º—É–∂—Å–∫–∞—è (–º–æ–¥–µ–ª—å–Ω–∞—è)", price:1200},
    {name:"–°—Ç—Ä–∏–∂–∫–∞ –¥–µ—Ç—Å–∫–∞—è", price:800},
    {name:"–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ (1 —Ç–æ–Ω)", price:4000},
    {name:"–£–∫–ª–∞–¥–∫–∞", price:1500},
    {name:"–ú–∞–Ω–∏–∫—é—Ä —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º", price:2000},
  ],
  schedule:{} // master -> date -> [time]
};
const qs=(s,r=document)=>r.querySelector(s);
const qsa=(s,r=document)=>[...r.querySelectorAll(s)];
const clone=(o)=>JSON.parse(JSON.stringify(o));
const slugify=s=>(s||'studio').toString().trim().toLowerCase()
  .normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
const initials = (n)=> n.trim().split(/\s+/).map(w=>w[0]).slice(0,2).join('').toUpperCase() || 'ST';

/* ===================== –ù–ê–ó–í–ê–ù–ò–ï –ò –°–°–´–õ–ö–ò ===================== */
function detectName(){
  const p=new URLSearchParams(location.search);
  if(location.hash.length>1) return decodeURIComponent(location.hash.slice(1)); // #–ù–∞–∑–≤–∞–Ω–∏–µ
  if(p.get('n')) return p.get('n'); // ?n=–ù–∞–∑–≤–∞–Ω–∏–µ
  // –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç –ø—É—Ç–∏ (–µ—Å–ª–∏ –Ω–µ index.html)
  const segs=location.pathname.split('/').filter(Boolean);
  const last=segs[segs.length-1];
  if(last && !/\.[a-z]+$/i.test(last) && last.toLowerCase()!=='index') return decodeURIComponent(last);
  return null;
}

/* ===================== –•–†–ê–ù–ò–õ–ò–©–ï ===================== */
function loadState(slug){
  try{
    const raw=localStorage.getItem('crm:'+slug);
    if(!raw) return null;
    const st=JSON.parse(raw);
    return st.version===VERSION ? st : null;
  }catch(e){ return null; }
}
function saveState(){ localStorage.setItem('crm:'+app.studio.slug, JSON.stringify(app)); }

/* ===================== –°–û–°–¢–û–Ø–ù–ò–ï ===================== */
let app = {
  version: VERSION,
  studio: { name: '–°—Ç—É–¥–∏—è', slug: 'studio' },
  currentView: 'client_yandex', // client_yandex | client_tg | admin_tg
  client: { id:'u'+Math.random().toString(36).slice(2,7), name:'–ì–æ—Å—Ç—å' },

  clientState:'main_menu',
  adminState:'main_menu',
  data: clone(DEFAULT_DATA),
  booking:{},
  bookings:[],
  chats:{ client:[], admin:[] },

  // –ù–æ–≤–æ–µ: –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–∞–∫–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —ç–∫—Ä–∞–Ω –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º
  ui: { clientLastView:'client_yandex', adminLastView:'admin_tg' }
};

/* ===================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===================== */
document.addEventListener('DOMContentLoaded', init);
function init(){
  const name = detectName() || '–°—Ç—É–¥–∏—è';
  const slug = slugify(name);
  const saved = loadState(slug);

  if(saved){
    app = saved;
    app.studio.name=name; app.studio.slug=slug;
    if(!app.ui) app.ui = { clientLastView:'client_yandex', adminLastView:'admin_tg' }; // –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
  }else{
    app.studio = { name, slug };
    pushClientBot('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –±–æ—Ç –∑–∞–ø–∏—Å–∏ —Å—Ç—É–¥–∏–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?');
    app.clientState='main_menu';
    app.ui = { clientLastView:'client_yandex', adminLastView:'admin_tg' };
    saveState();
  }
  renderAll();
}

/* ===================== –ù–ê–í–ò–ì–ê–¶–ò–Ø (—Ñ–∏–∫—Å ‚Äú—Å–ª—ë—Ç–∞‚Äù —ç–∫—Ä–∞–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞) ===================== */
// –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –µ—â—ë –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —ç–∫—Ä–∞–Ω
function go(view){
  app.currentView = view;
  if(view==='client_tg' || view==='client_yandex'){
    app.ui.clientLastView = view;
  }else if(view==='admin_tg'){
    app.ui.adminLastView = view;
  }
  saveState();
  renderAll();
}

/* ===================== –†–ï–ù–î–ï–† ===================== */
function renderAll(){
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π
  qs('#sw-client').classList.toggle('active', app.currentView.startsWith('client'));
  qs('#sw-admin').classList.toggle('active', app.currentView.startsWith('admin'));

  // ‚Äú–Ø–Ω–¥–µ–∫—Å‚Äù-—ç–∫—Ä–∞–Ω
  renderYx();

  // –¢–µ–ª–µ–≥—Ä–∞–º
  if(app.currentView==='client_tg') renderChat('client');
  if(app.currentView==='admin_tg') renderChat('admin');

  // –ü–æ–∫–∞–∑ –Ω—É–∂–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
  show(app.currentView==='client_yandex' ? 'screen-yx' : 'screen-tg');
}

function show(id){
  qsa('.screen').forEach(s=>s.classList.remove('visible'));
  qs('#'+id).classList.add('visible');
}

function renderYx(){
  qs('#yx-title').textContent = app.studio.name;
  qs('#tg-title').textContent = '–ó–∞–ø–∏—Å—å ‚Ä¢ ' + app.studio.name;
  const init = initials(app.studio.name);
  qs('#yx-ava').textContent = init;
  qs('#tg-ava').textContent = init;

  // –î–µ–º–æ–≥—Ä–∞—Ñ–∏–∫ ‚Äú–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏‚Äù (–¥–µ–º–æ)
  const b=qs('#busy'); b.innerHTML='';
  Array.from({length:12},()=>10+Math.random()*80|0).forEach(h=>{
    const d=document.createElement('div'); d.style.height=h+'%'; b.appendChild(d);
  });

  // –£—Å–ª—É–≥–∏ (–¥–µ–º–æ)
  qs('#svc').textContent = app.data.services.map(s=>`${s.name} ‚Äî ${s.price}‚ÇΩ`).join(' ‚Ä¢ ');
}

/* ===================== –ß–ê–¢ (–¢–µ–ª–µ–≥—Ä–∞–º) ===================== */
function renderChat(who){ // 'client' | 'admin'
  const chat=qs('#chat'); const kb=qs('#kb'); const inp=qs('#inp');
  chat.innerHTML=''; kb.innerHTML='';
  qs('#tg-sub').textContent = who==='client' ? '–±–æ—Ç –æ–Ω–ª–∞–π–Ω' : '–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';

  // –ò—Å—Ç–æ—Ä–∏—è
  app.chats[who].forEach(m=>{
    const wrap=document.createElement('div');
    wrap.className='msg ' + (m.role==='client' ? 'user' : 'bot');
    const bub=document.createElement('div');
    bub.className='bubble';
    bub.textContent = m.text;
    wrap.appendChild(bub);

    // –ö–Ω–æ–ø–∫–∏ –Ω–∞ –∑–∞—è–≤–∫–µ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ
    if(who==='admin' && m.meta && m.meta.type==='booking' && m.meta.status==='pending'){
      const actions=document.createElement('div');
      actions.className='inline-actions';
      const ok=btn('‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å','ok',()=>adminAction('approve', m.meta.id));
      const no=btn('‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å','no',()=>adminAction('decline', m.meta.id));
      actions.append(ok,no);
      bub.appendChild(actions);
    }
    chat.appendChild(wrap);
  });

  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
  const k = buildKb(who);
  if(k){
    const grid=document.createElement('div');
    grid.className='grid ' + (k.cols ? `cols-${k.cols}` : '');
    k.buttons.flat().forEach(bd=>{
      const b=btn(bd.text, bd.style, ()=> (who==='client'?clientAction:adminAction)(bd.action, bd.data));
      grid.appendChild(b);
    });
    kb.appendChild(grid);
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –∏–Ω–ø—É—Ç–∞
  qs('#send').onclick=()=>{
    const v=inp.value.trim(); if(!v) return;
    if(who==='client'){ pushClientUser(v); pushClientBot('–°–ø–∞—Å–∏–±–æ! –í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –º–µ–Ω—é –Ω–∏–∂–µ.'); }
    else { pushAdminUser(v); pushClientBot('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: ' + v); /* —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É => —á–∞—Ç –∞–∫—Ç—É–∞–ª–µ–Ω */ app.ui.clientLastView='client_tg'; saveState(); }
    inp.value=''; saveState(); renderChat(who);
  };

  chat.scrollTop = chat.scrollHeight;

  function btn(text, style, fn){
    const b=document.createElement('button');
    b.className='tbtn ' + (style||'');
    b.textContent=text; b.onclick=fn;
    return b;
  }
}

/* ===================== –ö–õ–ê–í–ò–ê–¢–£–†–´ ===================== */
function buildKb(who){
  if(who==='client'){
    switch(app.clientState){
      case 'main_menu':
        return {buttons:[
          [{text:'üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω', action:'state', data:'booking_master'}],
          [{text:'üíÖ –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã', action:'state', data:'services'}],
          [{text:'üìç –ê–¥—Ä–µ—Å –∏ –∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è', action:'state', data:'address'}],
          [{text:'‚Ü©Ô∏è –ù–∞ ‚Äú–∫–∞—Ä—Ç—ã‚Äù', action:'to_yx'}]
        ]};
      case 'services':
        return {buttons:[[ {text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'main_menu'} ]]};
      case 'address':
        return {buttons:[[ {text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'main_menu'} ]]};
      case 'booking_master': {
        const rows = app.data.masters.map(m=>[{text:m, action:'pick_master', data:m}]);
        rows.push([{text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'main_menu'}]);
        return {buttons:rows};
      }
      case 'booking_date': {
        const rows=[];
        for(let i=0;i<5;i++){ const d=new Date(); d.setDate(d.getDate()+i);
          rows.push([{text:d.toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'}), action:'pick_date', data:d.toISOString().slice(0,10)}]);
        }
        rows.push([{text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'booking_master'}]);
        return {buttons:rows};
      }
      case 'booking_time': {
        const m=app.booking.master, d=app.booking.date;
        const times=((app.data.schedule[m]||{})[d]||[]);
        const rows = times.length ? times.map(t=>[{text:t, action:'pick_time', data:t}]) : [];
        if(!rows.length) pushClientBot('–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.');
        rows.push([{text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'booking_date'}]);
        return {buttons:rows};
      }
    }
  }else{
    switch(app.adminState){
      case 'main_menu':
        return {buttons:[
          [{text:'üóì –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º', action:'state', data:'sched_master'}],
          [{text:'üßπ –°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ', action:'reset'}]
        ]};
      case 'sched_master': {
        const rows = app.data.masters.map(m=>[{text:m, action:'sched_pick_master', data:m}]);
        rows.push([{text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'main_menu'}]);
        return {buttons:rows};
      }
      case 'sched_date': {
        const rows=[];
        for(let i=0;i<7;i++){ const d=new Date(); d.setDate(d.getDate()+i);
          rows.push([{text:d.toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'}), action:'sched_pick_date', data:d.toISOString().slice(0,10)}]);
        }
        rows.push([{text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'sched_master'}]);
        return {buttons:rows};
      }
      case 'sched_time': {
        const m=app.adminMaster, d=app.adminDate;
        const schedule=(app.data.schedule[m]||{})[d]||[];
        const all=["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00"];
        const btns=all.map(t=>({text: t+(schedule.includes(t)?' ‚úì':''), action:'sched_toggle', data:t}));
        const grid=[]; for(let i=0;i<btns.length;i+=3) grid.push(btns.slice(i,i+3));
        grid.push([{text:'‚¨ÖÔ∏è –ù–∞–∑–∞–¥', action:'state', data:'sched_date'}]);
        return {buttons:grid, cols:3};
      }
    }
  }
  return null;
}

/* ===================== –î–ï–ô–°–¢–í–ò–Ø ===================== */
function clientAction(action, data){
  if(action==='to_yx'){ go('client_yandex'); return; }
  if(action==='state'){
    app.clientState=data;
    if(data==='services') pushClientBot('–ù–∞—à –ø—Ä–∞–π—Å:\n\n'+app.data.services.map(s=>`‚Ä¢ ${s.name}: ${s.price}‚ÇΩ`).join('\n'));
    if(data==='address')  pushClientBot('–ê–¥—Ä–µ—Å —Å–∫—Ä—ã—Ç (–¥–µ–º–æ). –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 10:00‚Äì21:00.');
    if(data==='main_menu') pushClientBot('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ß–µ–º –ø–æ–º–æ—á—å?');
  }
  if(action==='pick_master'){ app.booking={master:data}; app.clientState='booking_date'; pushClientBot(`–ú–∞—Å—Ç–µ—Ä: ${data}. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:`); }
  if(action==='pick_date'){ app.booking.date=data; app.clientState='booking_time'; pushClientBot(`–î–∞—Ç–∞: ${data}. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:`); }
  if(action==='pick_time'){
    app.booking.time=data;
    const b={ id:Date.now(), clientId:app.client.id, clientName:app.client.name, master:app.booking.master, date:app.booking.date, time:app.booking.time, status:'pending' };
    app.bookings.push(b);
    pushClientBot('–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
    pushAdminBot(`‚ùóÔ∏è –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞\n–ö–ª–∏–µ–Ω—Ç: ${b.clientName}\n–ú–∞—Å—Ç–µ—Ä: ${b.master}\n–ö–æ–≥–¥–∞: ${b.date} ${b.time}`, {type:'booking', id:b.id, status:'pending'});
    app.clientState='main_menu'; app.booking={};
  }
  saveState(); renderChat('client');
}

function adminAction(action, data){
  if(action==='reset'){ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ –∏ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')){ localStorage.removeItem('crm:'+app.studio.slug); location.reload(); } return; }
  if(action==='state'){
    app.adminState=data;
    if(data==='sched_master') pushAdminBot('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.');
  }
  if(action==='sched_pick_master'){ app.adminState='sched_date'; app.adminMaster=data; pushAdminBot(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${data}. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.`); }
  if(action==='sched_pick_date'){ app.adminState='sched_time'; app.adminDate=data; pushAdminBot(`–í–∫–ª—é—á–∞–π—Ç–µ/–≤—ã–∫–ª—é—á–∞–π—Ç–µ —Å–ª–æ—Ç—ã –Ω–∞ ${data}.`); }
  if(action==='sched_toggle'){
    const m=app.adminMaster, d=app.adminDate, t=data;
    if(!app.data.schedule[m]) app.data.schedule[m]={};
    if(!app.data.schedule[m][d]) app.data.schedule[m][d]=[];
    const arr=app.data.schedule[m][d]; const i=arr.indexOf(t);
    if(i>-1) arr.splice(i,1); else arr.push(t);
    pushAdminBot(`–°–ª–æ—Ç ${t} ‚Äî ${i>-1?'–≤—ã–∫–ª—é—á–µ–Ω':'–≤–∫–ª—é—á–µ–Ω'}.`);
  }
  if(action==='approve' || action==='decline'){
    const b=app.bookings.find(x=>x.id===data); if(!b) return;
    b.status = action==='approve' ? 'approved' : 'declined';
    pushAdminBot( b.status==='approved'
      ? `‚úÖ –ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞\n${b.master} ‚Ä¢ ${b.date} ${b.time}`
      : `‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞` );
    // –°–æ–æ–±—â–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞—Ö–æ–¥ –Ω–∞ ‚Äú–ö–ª–∏–µ–Ω—Ç–∞‚Äù –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
    pushClientBot( b.status==='approved'
      ? `‚úÖ –í–∞—à–∞ –∑–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n${b.master} ‚Ä¢ ${b.date} ${b.time}`
      : `‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.` );
    app.ui.clientLastView = 'client_tg';
    saveState();

    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞ —É –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ
    for(let i=app.chats.admin.length-1;i>=0;i--){
      const m=app.chats.admin[i]; if(m.meta && m.meta.type==='booking' && m.meta.id===b.id){ m.meta.status=b.status; break; }
    }
  }
  saveState(); renderChat('admin');
}

/* ===================== –°–û–û–ë–©–ï–ù–ò–Ø ===================== */
function pushClientBot(text,meta){ app.chats.client.push({id:Date.now()+Math.random(), role:'bot', text, ts:Date.now(), meta}); saveState(); }
function pushClientUser(text){ app.chats.client.push({id:Date.now()+Math.random(), role:'client', text, ts:Date.now()}); saveState(); }
function pushAdminBot(text,meta){ app.chats.admin.push({id:Date.now()+Math.random(), role:'bot', text, ts:Date.now(), meta}); saveState(); }
function pushAdminUser(text){ app.chats.admin.push({id:Date.now()+Math.random(), role:'client', text, ts:Date.now()}); saveState(); }

/* ===================== UI: –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏, –∫–Ω–æ–ø–∫–∏ ===================== */
// –¢–µ–ø–µ—Ä—å ‚Äú–ö–ª–∏–µ–Ω—Ç‚Äù –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —ç–∫—Ä–∞–Ω (–ø–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ ‚Äî —á–∞—Ç)
qs('#sw-client').onclick=()=>{ go(app.ui?.clientLastView || 'client_tg'); };
// ‚Äú–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä‚Äù ‚Äî –≤—Å–µ–≥–¥–∞ –∞–¥–º–∏–Ω—Å–∫–∏–π —á–∞—Ç
qs('#sw-admin').onclick=()=>{ go('admin_tg'); };
// –ö–Ω–æ–ø–∫–∞ ‚Äú–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω‚Äù ‚Äî —Å—Ä–∞–∑—É –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ
qs('#open-tg').onclick=()=>{ go('client_tg'); };

// –ü—É—Å—Ç—ã—à–∫–∏-—Ñ—É—Ç–µ—Ä–∞
qs('#route').onclick=()=>alert('–î–µ–º–æ: –∞–¥—Ä–µ—Å —Å–∫—Ä—ã—Ç.');
qs('#call').onclick=()=>alert('–î–µ–º–æ: —Ç–µ–ª–µ—Ñ–æ–Ω —Å–∫—Ä—ã—Ç.');
qs('#share').onclick=()=>{
  const base = location.origin + location.pathname.replace(/\/[^\/]*$/,'/'); // –∫–∞—Ç–∞–ª–æ–≥
  const link = base + 'index.html#' + encodeURIComponent(app.studio.name);
  navigator.clipboard.writeText(link).then(()=>alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n'+link)).catch(()=>alert(link));
};
</script>
</body>
</html>
